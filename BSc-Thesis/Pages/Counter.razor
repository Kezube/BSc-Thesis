@page "/counter"
@using System.Reflection
@using System.Reflection
@inject ProcessStore ProcessStore


<PageTitle>Counter</PageTitle>
<SelectList TItem="string"
            TValue="string"
            Data="@ColumneNames"
            TextField="@((item)=>item)"
            ValueField="@((item)=>item)"
            DefaultItemText="Filtr" 
            SelectedValueChanged="OnSelected"/>
            
<SelectList TItem="int"
            TValue="int"
            Data="@ProcessCout"
            TextField="@((item)=>item.ToString())"
            ValueField="@((item)=>item)"
            DefaultItemText="Nr Procesu" 
            SelectedValueChanged="OnSelectedID"/>


<LineChart @ref="lineChart" TItem="WatcherEvent" Options="@lineChartOptions" />
@code {
    private LineChart<WatcherEvent> lineChart;
    private ProcessDb[] processList;
    private static string[] ColumneNames = new string[] { };
    private string filterSelectedValue;
    private static int[] ProcessCout = new int[] {1,2,3,4,5};
    private int selectedID;
    private List<WatcherEvent> dataList = new List<WatcherEvent>();

    private ProcessDb[] processListFiltered;

    LineChartOptions lineChartOptions = new()
    {
        Parsing = new ChartParsing
        {
            XAxisKey = "sector",
            YAxisKey = "count",
        }
    };

    private List<string> backgroundColors = new() { ChartColor.FromRgba( 255, 99, 132, 0.2f ), ChartColor.FromRgba( 54, 162, 235, 0.2f ), ChartColor.FromRgba( 255, 206, 86, 0.2f ), ChartColor.FromRgba( 75, 192, 192, 0.2f ), ChartColor.FromRgba( 153, 102, 255, 0.2f ), ChartColor.FromRgba( 255, 159, 64, 0.2f ) };
    private List<string> borderColors = new() { ChartColor.FromRgba( 255, 99, 132, 1f ), ChartColor.FromRgba( 54, 162, 235, 1f ), ChartColor.FromRgba( 255, 206, 86, 1f ), ChartColor.FromRgba( 75, 192, 192, 1f ), ChartColor.FromRgba( 153, 102, 255, 1f ), ChartColor.FromRgba( 255, 159, 64, 1f ) };

    private bool isAlreadyInitialised;

    public class WatcherEvent
    {
        public string Sector { get; set; }

        public double Count { get; set; }

        public DateTime Date { get; set; }
    }

    protected override async Task OnAfterRenderAsync( bool firstRender )
    {

        await lineChart.Clear();
        await lineChart.AddDataSet( GetLineChartDataset() );

    }

    protected override async Task OnInitializedAsync()
    {
        ColumneNames = GetColumneNames();
        processList = await ProcessStore.GetAllRows();
        processListFiltered = processList;
        await base.OnInitializedAsync();
    }


    private LineChartDataset<WatcherEvent> GetLineChartDataset()
    {
        processList = processListFiltered;
        return new()
        {
            Label = "Cos",
            Data = dataList,
            BorderColor = borderColors[1],
            Fill = true,
            PointRadius = 3,
            BorderWidth = 1,
            PointBorderColor = Enumerable.Repeat( borderColors.First(), 6 ).ToList(),
            CubicInterpolationMode = "monotone",

        };
    }

    private string[] GetColumneNames()
    {
        Type type = typeof(ProcessDb);
        PropertyInfo[] properties = type.GetProperties();
        return properties.Select(x => x.Name).ToArray();
    }

    private async void OnSelectedID(int value)
    {
        selectedID = value;
        processListFiltered = await ProcessStore.GetAllRowsByID(selectedID);

        OnSelected(filterSelectedValue);
    }

    private async void OnSelected(string value)
    {
        filterSelectedValue = value;
        isAlreadyInitialised = false;
        switch (filterSelectedValue)
        {
            case "Temperature":
                foreach (var processDb in processListFiltered)
                {
                    var watcherEvent = new WatcherEvent()
                    {
                        Sector = processDb.ID.ToString(),
                        Count = processDb.Temperature,
                        Date = processDb.Date
                    };
                    dataList.Add(watcherEvent);
                }
                break;
            case "AmbientTemperature":
                foreach (var processDb in processListFiltered)
                {
                    var watcherEvent = new WatcherEvent()
                    {
                        Sector = processDb.ID.ToString(),
                        Count = processDb.AmbientTemperature,
                        Date = processDb.Date
                    };
                    dataList.Add(watcherEvent);
                }
                break;
            case "Glucose":
                foreach (var processDb in processListFiltered)
                {
                    var watcherEvent = new WatcherEvent()
                    {
                        Sector = processDb.ID.ToString(),
                        Count = processDb.Glucose,
                        Date = processDb.Date
                    };
                    dataList.Add(watcherEvent);
                }
                break;
            case "Maltose":
                foreach (var processDb in processListFiltered)
                {
                    var watcherEvent = new WatcherEvent()
                    {
                        Sector = processDb.ID.ToString(),
                        Count = processDb.Maltose,
                        Date = processDb.Date
                    };
                    dataList.Add(watcherEvent);
                }
                break;
            case "Maltotriosis":
                foreach (var processDb in processListFiltered)
                {
                    var watcherEvent = new WatcherEvent()
                    {
                        Sector = processDb.ID.ToString(),
                        Count = processDb.Maltotriosis,
                        Date = processDb.Date
                    };
                    dataList.Add(watcherEvent);
                }
                break;
            case "Sugar":
                foreach (var processDb in processListFiltered)
                {
                    var watcherEvent = new WatcherEvent()
                    {
                        Sector = processDb.ID.ToString(),
                        Count = processDb.Sugar,
                        Date = processDb.Date
                    };
                    dataList.Add(watcherEvent);
                }
                break;
            case "DeadYeast":
                foreach (var processDb in processListFiltered)
                {
                    var watcherEvent = new WatcherEvent()
                    {
                        Sector = processDb.ID.ToString(),
                        Count = processDb.DeadYeast,
                        Date = processDb.Date
                    };
                    dataList.Add(watcherEvent);
                }
                break;
            case "ActiveYeast":
                foreach (var processDb in processListFiltered)
                {
                    var watcherEvent = new WatcherEvent()
                    {
                        Sector = processDb.ID.ToString(),
                        Count = processDb.ActiveYeast,
                        Date = processDb.Date
                    };
                    dataList.Add(watcherEvent);
                }
                break;
            case "LatticeYeast":
                foreach (var processDb in processListFiltered)
                {
                    var watcherEvent = new WatcherEvent()
                    {
                        Sector = processDb.ID.ToString(),
                        Count = processDb.LatticeYeast,
                        Date = processDb.Date
                    };
                    dataList.Add(watcherEvent);
                }
                break;
            case "Ethanol":
                foreach (var processDb in processListFiltered)
                {
                    var watcherEvent = new WatcherEvent()
                    {
                        Sector = processDb.ID.ToString(),
                        Count = processDb.Ethanol,
                        Date = processDb.Date
                    };
                    dataList.Add(watcherEvent);
                }
                break;
            default:
                foreach (var processDb in processListFiltered)
                {
                    var watcherEvent = new WatcherEvent()
                    {
                        Sector = processDb.ID.ToString(),
                        Count = processDb.Temperature,
                        Date = processDb.Date
                    };
                    dataList.Add(watcherEvent);
                }
                break;

        }

        OnAfterRenderAsync(false);

        


        
    }
    
}



